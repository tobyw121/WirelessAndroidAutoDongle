#!/bin/sh
#
# Setup hostapd configuration
#

case "$1" in
	start)
		if [ -z "$AAWG_CONF_SOURCED" ]; then
			echo "Source /etc/aawgd.conf"
			source /etc/aawgd.conf
		fi

		if [ "${AAWG_WIFI_MODE}" = "client" ]; then
			echo "Skipping hostapd configuration for wifi client mode"
			exit 0
		fi

		WIFI_INTERFACE="${AAWG_WIFI_INTERFACE:-wlan0}"
		AP_ADDRESS="10.0.0.1/24"

		echo "Generate hostapd configuration at /var/run/hostapd.conf"

		sed "s/@WIFI_INTERFACE@/${WIFI_INTERFACE}/g" /etc/hostapd.conf.in > /var/run/hostapd.conf

		echo >> /var/run/hostapd.conf

		# Add Wifi password
		if [ -n "${AAWG_WIFI_PASSWORD}" ]; then
			echo "wpa_passphrase=${AAWG_WIFI_PASSWORD}" >> /var/run/hostapd.conf
		fi

		# Add Wifi country code if set
		if [ -n "${AAWG_COUNTRY_CODE}" ]; then
			echo "country_code=${AAWG_COUNTRY_CODE}" >> /var/run/hostapd.conf
		fi

		if command -v ip >/dev/null 2>&1; then
			ip link set "${WIFI_INTERFACE}" up || true
			if ! ip addr show dev "${WIFI_INTERFACE}" | grep -q " ${AP_ADDRESS%/*}/"; then
				ip addr add "${AP_ADDRESS}" dev "${WIFI_INTERFACE}" || true
			fi
		elif command -v ifconfig >/dev/null 2>&1; then
			ifconfig "${WIFI_INTERFACE}" 10.0.0.1 netmask 255.255.255.0 up || true
		fi

		if [ ! -f /etc/dnsmasq.conf ] && [ -f /etc/dnsmasq.conf.in ]; then
			sed "s/@WIFI_INTERFACE@/${WIFI_INTERFACE}/g" /etc/dnsmasq.conf.in > /etc/dnsmasq.conf
		fi

		if command -v hostapd >/dev/null 2>&1; then
			echo "Starting hostapd on ${WIFI_INTERFACE}"
			hostapd -B /var/run/hostapd.conf -t -f /var/log/hostapd
		fi

		if command -v dnsmasq >/dev/null 2>&1; then
			echo "Starting dnsmasq"
			dnsmasq -C /etc/dnsmasq.conf
		fi
		;;
	*)
		echo "Usage: $0 {start}"
		exit 1
esac

exit $?
