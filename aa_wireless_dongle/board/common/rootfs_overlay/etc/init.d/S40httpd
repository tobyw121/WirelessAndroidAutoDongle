#!/bin/sh
#
# Start configuration web server
#

case "$1" in
	start)
		if [ -z "$AAWG_CONF_SOURCED" ]; then
			echo "Source /etc/aawgd.conf"
			source /etc/aawgd.conf
		fi

		if [ "${AAWG_ENABLE_WEB_UI}" != "1" ]; then
			echo "Web UI disabled"
			exit 0
		fi

		WEB_UI_BIND="${AAWG_WEB_UI_BIND:-0.0.0.0}"
		WEB_UI_PORT="${AAWG_WEB_UI_PORT:-80}"
		HTTPD_BIND="${WEB_UI_BIND}:${WEB_UI_PORT}"
		WIFI_INTERFACE="${AAWG_WIFI_INTERFACE:-wlan0}"

		if [ "${AAWG_WIFI_MODE}" = "ap" ]; then
			if command -v ip >/dev/null 2>&1; then
				for _ in 1 2 3 4 5 6 7 8 9 10; do
					if ip addr show dev "${WIFI_INTERFACE}" | grep -q " 10.0.0.1/"; then
						break
					fi
					sleep 1
				done
			elif command -v ifconfig >/dev/null 2>&1; then
				for _ in 1 2 3 4 5 6 7 8 9 10; do
					if ifconfig "${WIFI_INTERFACE}" 2>/dev/null | grep -q "inet addr:10.0.0.1"; then
						break
					fi
					sleep 1
				done
			fi
		fi

		echo "Starting web UI on http://${WEB_UI_BIND}:${WEB_UI_PORT}/"
		httpd -p "${HTTPD_BIND}" -h /www -c /etc/httpd.conf
		;;
	*)
		echo "Usage: $0 {start}"
		exit 1
esac

exit $?
